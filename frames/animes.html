<!DOCTYPE html>
<html>

    <head>
        <title>Flixtor</title>
        <!-- CSS -->
        <link href="../styles/bootstrap.min.css" rel="stylesheet">
        <link href="../styles/bootly.css" rel="stylesheet">
        <link href="../styles/general.css" rel="stylesheet">

        <link href="../styles/series.css" rel="stylesheet">

        <!-- Scripts -->
        <script type='text/javascript' src="../js/extensions/jquery.min.js"></script>
        <script type='text/javascript' src="../js/extensions/bootstrap.min.js"></script>
        <script type='text/javascript' src="../js/extensions/jquery-ui.js"></script>
        <script type='text/javascript' src="../js/extensions/circle-progress.js"></script>

        <script src="../js/extensions/jquery.isotope.min.js"></script>
        <script src="../js/extensions/nwcontextmenu.js"></script>

        <!-- Modules -->
        <script>
            var main = require('../js/main.js');
            var callwcf = require('../js/callwcf.js');
            var gui = require('nw.gui');
            var subtitles = require('../js/subtitle.js');
            var favorites = require('../js/favorites.js');
            var translations = require('../js/translations.js');
            var dateFormat = require('dateformat');
            var readTorrent = require('read-torrent');
            var health = require('torrent-health');
            var xbmc = require('nodebmc');
            var chromecastjs = require('chromecast-js');
            var xbmcDevices = [];
            var chromecastDevices = [];

            $(document).ready(function() {

                translations.initialize();
                translations.translateDefaults();

                //Scroll bar
                $(window).resize(function() {
                    $("#serieContainer").css('max-height', ($(window).height() - 105) + "px");
                    var height = $("#content").height()-25;
                    $(".container").height(height);
                }).trigger("resize");

                //Search key press (enter)
                $('#txtAnimeSearch').keypress(function(e) {
                    if (e.keyCode == 13)
                        $('#btnSearchSerie').click();
                });

                //By default we filter by most downloaded.
                changeFilterCategory("popularity");

                $("#txtAnimeSearch").bind('keyup paste', function() {
                    clearTimeout($(this).data('timeout'));
                    $(this).data('timeout', setTimeout(function(){
                        var serieSearchValue = $('#txtAnimeSearch').val();

                        if(serieSearchValue.indexOf('magnet:?xt=urn:btih:') == 0) {
                            $("#btnSearchSerie").text('Play');
                        }
                        else {
                            $( "#btnSearchSerie" ).empty();
                            $("#btnSearchSerie").append('<span class="glyphicon glyphicon-search"></span>');
                        }
                    }, 200));
                });

                $.fn.inView = function(){
                    var win = $(window);
                    obj = $(this);
                    var scrollPosition = win.scrollTop();
                    var visibleArea = win.scrollTop() + win.height();
                    var objEndPos = (obj.offset().top + obj.outerHeight());

                    return(visibleArea >= objEndPos && scrollPosition <= objEndPos ? true : false)
                };

                $('#serieContainer').scroll(function() {
                    var element = $('.last').on('find');
                    if(element.length > 0) {
                        if(element.inView() === true) {
                            animeFilter.page = animeFilter.page+1;
                            element.removeClass('last');
                            animeApplySearch();
                        }
                    }
                });

                // Browse for xbmc clients
                var xbmcBrowser = new xbmc.Browser();
                xbmcBrowser.on('deviceOn', function(device){
                    xbmcDevices.push(device);
                });

                // Browse for chromecast clients
                var chromecastBrowser = new chromecastjs.Browser();
                chromecastBrowser.on('deviceOn', function(device){
                    chromecastDevices.push(device);
                })
            });
        </script>
    </head>
    <body>
    <div id="wrapper">
            <div id="top-bar-wrapper">
                <div id="top-bar">
                    <a href="#" class="col-sm-2 col-xs-2 col-md-2 header-element">
                        Flixtor
                    </a>
                    <a href="#" class="col-sm-2 col-xs-2 col-md-2 header-element menuMovies" onclick="main.changeFrame('movies')">

                    </a>
                    <a href="#" class="col-sm-2 col-xs-2 col-md-2 header-element menuSeries" onclick="main.changeFrame('series')">

                    </a>
                    <a href="#" class="col-sm-2 col-xs-2 col-md-2 header-element menuAnimes selected" onclick="main.changeFrame('animes')">

                    </a>
                    <a href="#" class="col-sm-2 col-xs-2 col-md-2 header-element menuTorrents" onclick="main.changeFrame('torrents')">

                    </a>

                    <div type="button" class="top-titlebar-minimize-button" title="" onclick="main.minimize();">
                        <span class="glyphicon glyphicon-minus"></span>
                    </div>
                    <div type="button" class="top-titlebar-fullscreen-button" title="" onclick="main.toggleFullScreen();">
                        <span class="glyphicon glyphicon-fullscreen"></span>
                    </div>
                    <div class="top-titlebar-close-button" onclick="main.closeApp();" title="">
                        <span class="glyphicon glyphicon-remove"></span>
                    </div>
                </div>
            </div>
            <div id="content-wrapper">
                <div id="content" style="background: rgba(0,0,0, 0.2);">
                    <script>
                        var animeFilter = {};

                        function animeApplySearch() {
                            //Show the spinner while we wait to display all the animes
                            $("#wrapper").append("<div id='main-spinner' class='spinner-overlay'></div>");

                            //By default we skip to 0.
                            if (!animeFilter.page) {
                                animeFilter.page = 0;
                            }

                            //We display a maximum of 50
                            if (!animeFilter.max) {
                                animeFilter.max = 50;
                            }

                            // Default search type
                            if (!animeFilter.type) {
                                animeFilter.type = 'All';
                            }

                            // Default genre
                            if (!animeFilter.genre) {
                                animeFilter.genre = '';
                            }

                            // Default keywords
                            if (!animeFilter.searchValue) {
                                animeFilter.searchValue = '';
                            }

                            // Default sort
                            if (!animeFilter.sort) {
                                animeFilter.sort = 'popularity';
                            }

                            // Default status
                            if (!animeFilter.status) {
                                animeFilter.status = '';
                            }

                            // Default sort order
                            if (!animeFilter.order) {
                                animeFilter.order = 'asc';
                            }

                            //Search for animes
                            callwcf.searchAnimes( animeFilter.page, animeFilter.type, animeFilter.sort, animeFilter.genre, animeFilter.searchValue, animeFilter.status, animeFilter.order, animeFilter.max, function(results) {

                                var content = "";
                                if( results !== 'error' ) {
                                    $(results).each(function(index) {
                                        var anime = results[index];

                                        if (typeof anime.malimg !== 'undefined') {
                                            var animePoster = anime.malimg;
                                        }
                                        else {
                                            var animePoster = '../images/no-poster.png';
                                        }
                                        content += "<div class='element transition m-10 isotope-item'>" +
                                            "<a class='shadow' onClick='showDetails(this);'>" +
                                            "<div style='display: none'>"+anime.id+"</div> " +
                                            "<img alt='image' src='" + animePoster + "' style='width:160px; height:230px;'/>" +
                                            "</a>" +
                                            "<div class='p-5' style='max-width:160px;'>" +
                                            "<div style='font-size:14px;'>" + anime.name + "</div>" +
                                            "</div>" +
                                            "<div style='clear:both'></div>" +
                                            "</div>";
                                    });

                                }
                                else {
                                    console.log("Service not available");
                                }

                                if (content != "") {

                                    var $container = $('#serieContainer');
                                    $container.append(content);
                                    $container.isotope("insert", $container);

                                    $( ".element" ).last().addClass('last');
                                }

                                //Remove the spinner since we got the data we wanted
                                $("#main-spinner").remove();
                            });

                        }

                        function changeSearchText() {
                            animeFilter.page = 0;
                            animeFilter.searchValue = $("#txtAnimeSearch").val();
                            $("#serieContainer").empty();
                            $('#serieContainer').isotope("destroy");
                            $('#serieContainer').isotope({
                                itemSelector: '.element',
                                animationEngine: 'jquery',
                                layoutMode: 'fitRows',
                                animationOptions: {
                                    duration: 600,
                                    easing: 'linear',
                                    queue: false
                                }
                            });

                            if(animeFilter.searchValue.indexOf('magnet:?xt=urn:btih:') == 0) {
                                var infoHash = animeFilter.searchValue.split('magnet:?xt=urn:btih:');
                                main.go("players/player.html?torrentId=" + infoHash[1]);
                            }
                            else {
                                animeApplySearch();
                            }
                        }

                        function startTorrent(infoHash) {
                            //Hide view episodes panel and start the torrent
                            $("#divSD").addClass("hide");
                            main.playTorrent(infoHash);
                        }

                        function showDetails(animeID) {
                            $("#wrapper").append("<div id='main-spinner' class='spinner-overlay'></div>");
                            $('#title' ).empty();
                            $('.favorites-template').empty();
                            $('#genres').empty();
                            $('#genres').append('<span class="glyphicon glyphicon-tag"></span>&nbsp;&nbsp');
                            $('#rating').css('width', '0% !important');
                            $('#rating').attr('title', '');
                            $('#plot').empty();
                            $('#network').empty();
                            $('#network').append('<span class="glyphicon glyphicon-home"></span>&nbsp;&nbsp');
                            $('#runtime').empty();
                            $('#runtime').append('<span class="glyphicon glyphicon-time"></span>&nbsp;&nbsp');
                            $('#date').empty();
                            $('#date').append('<span class="glyphicon glyphicon-calendar"></span>&nbsp;&nbsp;');
                            $('#info').empty();
                            $('#info').append('<span class="glyphicon glyphicon-info-sign"></span>&nbsp;&nbsp;');

                            var anime = animeID.firstChild.innerHTML;
                            var torrents;
                            var currentTorrent;
                            var currentSubtitle;
                            var episodeTitle;

                            $(chromecastDevices).each(function(index) {
                                var device = chromecastDevices[index];
                                $("#serie .dropdown-toggle").removeClass( "disabled" );
                                $("#serie .devices").append('<li class="chromecastPlay" data-name="'+device.config.name+'"><a><i class="glyphicon glyphicon-play"></i>&nbsp;&nbsp;'+device.config.name+'</a></li>');
                            });

                            $(xbmcDevices).each(function(index) {
                                var device = xbmcDevices[index];
                                $("#serie .dropdown-toggle").removeClass( "disabled" );
                                $("#serie .devices").append('<li class="xmbcPlay" data-name="'+device.name+'"><a><i class="glyphicon glyphicon-play"></i>&nbsp;&nbsp;'+device.name+'</a></li>');
                            });

                            callwcf.searchAnimeDetail( anime, function(results) {
                                if( results !== 'error' ) {
                                    anime = results;

                                    favorites.checkIfFavorite( anime.id, function(result) {
                                        if( result == true ) {
                                            $(".favorites-template").append('<label onclick="removeFromFavorites(this)" title="Remove from favorites" class="current-favorites"><div style="display: none">'+JSON.stringify(anime)+'</div><i class="glyphicon glyphicon-heart"></i></label>');
                                        }
                                        else {
                                            $(".favorites-template").append('<label onclick="addToFavorites(this);" title="Add to favorites" class="current-favorites"><div style="display: none">'+JSON.stringify(anime)+'</div><i class="glyphicon glyphicon-heart-empty"></i></label>');
                                        }
                                    });

                                    //Set variables to html
                                    $("#poster").attr('src', anime.malimg);

                                    $("#title").html(anime.name);

                                    var translatedGen;
                                    var translatedGenres = [];
                                    var tmpGenres = anime.genres.split(', ');
                                    $(tmpGenres).each(function(index) {
                                        var gen = tmpGenres[index];
                                        translatedGen = translations.translate(gen);
                                        translatedGenres.push(translatedGen);
                                    });
                                    var genres = translatedGenres.join(", ");
                                    $("#genres").append(genres);

                                    if(anime.synopsis) {
                                        $("#plot").html(anime.synopsis);
                                    }else {
                                        $("#plot").addClass("hide");
                                    }

                                    if(anime.duration) {
                                        $("#runtime").append(anime.duration);
                                    } else {
                                        $("#runtime").addClass("hide");
                                    }

                                    if(anime.aired) {
                                        $("#date").append(anime.aired);
                                    } else {
                                        $("#date").addClass("hide");
                                    }

                                    $("#info").append(anime.season);

                                    if(anime.producers) {
                                        $("#network").append(anime.producers);
                                    } else {
                                        $("#network").addClass("hide");
                                    }

                                    $("#rating").attr("style", "width:" + anime.score*10 + "% !important");
                                    $("#rating").attr("title", anime.score+"/10");

                                    var formatMovie = function (id, episodes) {
                                        var torrents = {};
                                        $(episodes).each(function(index) {
                                            var item = episodes[index];
                                            var quality = item.quality.match(/[0-9]+p/)[0];
                                            torrents['torrents'] = {};
                                            torrents['torrents'][quality] = {
                                                url: item.magnet
                                            };
                                            torrents['first_aired'] = item.time;
                                        });

                                        return torrents;
                                    };

                                    var formatTV = function (id, episodes) {
                                        var torrents = {};
                                        $(episodes).each(function(index) {
                                            var item = episodes[index];
                                            var quality = item.quality.match(/[0-9]+p/)[0];
                                            var match = item.name.match(/[\s_]([0-9]+(-[0-9]+)?|CM|OVA)[\s_]/);
                                            if (!match) {
                                                return;
                                            }
                                            var episode = match[1];
                                            if (!torrents[episode]) {
                                                torrents[episode] = {};
                                                torrents[episode]['torrents'] = {};
                                            }
                                            torrents[episode]['title'] = episode;
                                            torrents[episode]['first_aired'] = item.time;
                                            torrents[episode]['torrents'][quality] = {
                                                url: item.magnet
                                            };
                                        });
                                        return torrents;
                                    };

                                    if( anime.type == "Movie" ) {
                                        anime.episodes = formatMovie(anime.id, anime.episodes);
                                    }
                                    else {
                                        anime.episodes = formatTV(anime.id, anime.episodes);
                                    }

                                    var translatedSeason = translations.translate('Season');
                                    var translatedEpisode = translations.translate('Episode');

                                    $("#accordion").append('<h3 id="season-1" class="accordion-header">'+translatedSeason+' 1</h3>');

                                    $("#season-1").after('<div class="episode-wrapper"></div>');

                                    if( anime.type == "Movie" ) {
                                        var airDate = dateFormat(new Date(anime.episodes.first_aired * 1000), "dd mmm yy");

                                        $("#season-1").next().append("<div class='episode' data-date='" + anime.episodes.first_aired + "' data-episode='1' data-season='1' data-title='" + escape(anime.name) + "' data-torrents='" + JSON.stringify(anime.episodes.torrents) + "'><div style='color: #61666d; float: left; margin-right: 10px;'>1</div><div style='float: left'>"+anime.name+"</div><div style='color: #61666d; float: right'>&nbsp;&nbsp;&nbsp;"+airDate+"</div><div style='clear: both;'</div></div>");

                                    }
                                    else {
                                        for(var index in anime.episodes) {
                                            var episode = anime.episodes[index];
                                            var airDate = dateFormat(new Date(episode.first_aired * 1000), "dd mmm yy");

                                            $("#season-1").next().append("<div class='episode' data-date='" + episode.first_aired + "' data-episode='" + index + "' data-season='1' data-title='" + escape(episode.title) + "' data-torrents='" + JSON.stringify(episode.torrents) + "'><div style='color: #61666d; float: left; margin-right: 10px;'>"+episode.title+"</div><div style='float: left'>"+translatedEpisode+" "+episode.title+"</div><div style='color: #61666d; float: right'>&nbsp;&nbsp;&nbsp;"+airDate+"</div><div style='clear: both;'</div></div>");
                                        }
                                    }

                                    $( "#accordion" ).accordion({
                                        heightStyle: "content",
                                        collapsible: true
                                    });

                                    $(".episode").click(function () {
                                        $("#episode-title").empty();
                                        $("#quality").empty();
                                        $("#episode-airdate").empty();
                                        $("#episode-info").empty();
                                        $("#episode-overview").empty();

                                        $(".selected").removeClass("selected");
                                        $(".media").removeClass("on");
                                        $(this).addClass("selected");

                                        episodeTitle = unescape($(this).data("title"));
                                        var airDate = $(this).data("date");
                                        airDate = dateFormat(new Date(airDate * 1000), "dddd, mmmm dS, yyyy, h:MM TT");

                                        var episode = $(this).data("episode");
                                        var season = $(this).data("season");
                                        torrents = $(this).data("torrents");


                                        for (var key in torrents) {
                                            var torrent = torrents[key];
                                            if( key !== '0' ) {
                                                $("#quality").append('<button data-torrent="'+torrent.url+'" class="btn btn-quality" style="width: 100%;">'+key+'<label title=""><div style="width: 20px; position: absolute; top: 2px; right: 5px;" class="circle"></div></label></button>');
                                            }
                                        }

                                        $('.circle').circleProgress({
                                            value: 0,
                                            thickness: 2,
                                            size: 14,
                                            emptyFill: "#272f3a"
                                        });

                                        // Select first quality
                                        $("#quality").find(".btn-quality:first").trigger("click");

                                        $("#episode-title").append(translatedEpisode+" "+episodeTitle);
                                        $("#episode-info").append(translatedSeason+" "+season+" "+translatedEpisode+" "+episode);
                                        $("#episode-airdate").append("Airdate: "+airDate);

                                    });

                                    $("#btnBuy").click(function () {
                                        var shoppingUrl = 'https://www.google.com/search?q='+anime.name+' anime&tbm=shop';
                                        gui.Shell.openExternal(shoppingUrl);
                                    });

                                    /*$("#btnEpisodeList").click(function () {
                                        main.go("players/anime-player.html?animeId=" + anime.id);
                                    });*/

                                    $("#btnPlay").click(function () {
                                        var tmpCurrentTorrent = currentTorrent.split('magnet:?xt=urn:btih:');
                                        tmpCurrentTorrent = tmpCurrentTorrent[1];
                                        tmpCurrentTorrent = new Buffer(JSON.stringify(tmpCurrentTorrent)).toString('base64');
                                        var tmpTorrents = new Buffer(JSON.stringify(torrents)).toString('base64');
                                        var tmpTitle = new Buffer(JSON.stringify(episodeTitle)).toString('base64');
                                        main.go("players/series-player.html?magnet=" + tmpCurrentTorrent+"&torrents="+tmpTorrents+"&title="+tmpTitle+"&subtitle="+currentSubtitle);
                                    });

                                    $("body").on("click", ".xmbcPlay", function () {
                                        var deviceId = $(this).data("name");
                                        var tmpCurrentTorrent = currentTorrent.split('magnet:?xt=urn:btih:');
                                        tmpCurrentTorrent = tmpCurrentTorrent[1];
                                        tmpCurrentTorrent = new Buffer(JSON.stringify(tmpCurrentTorrent)).toString('base64');
                                        var tmpTorrents = new Buffer(JSON.stringify(torrents)).toString('base64');
                                        var tmpTitle = new Buffer(JSON.stringify(episodeTitle)).toString('base64');
                                        main.go("players/series-player.html?magnet=" + tmpCurrentTorrent+"&torrents="+tmpTorrents+"&title="+tmpTitle+"&xbmc="+deviceId);
                                    });

                                    $("body").on("click", ".chromecastPlay", function () {
                                        var deviceId = $(this).data("name");
                                        var tmpCurrentTorrent = currentTorrent.split('magnet:?xt=urn:btih:');
                                        tmpCurrentTorrent = tmpCurrentTorrent[1];
                                        tmpCurrentTorrent = new Buffer(JSON.stringify(tmpCurrentTorrent)).toString('base64');
                                        var tmpTorrents = new Buffer(JSON.stringify(torrents)).toString('base64');
                                        var tmpTitle = new Buffer(JSON.stringify(episodeTitle)).toString('base64');
                                        main.go("players/series-player.html?magnet=" + tmpCurrentTorrent+"&torrents="+tmpTorrents+"&title="+tmpTitle+"&chromecast="+deviceId);
                                    });

                                    $("body").on("click", ".btn-quality", function () {
                                        $(".btn-quality").removeClass("current");
                                        $(this).addClass('current');
                                        var current = $(this);
                                        var torrent = $(this).data("torrent");

                                        $(current).find('.circle').hide();
                                        $(current).find('label').append('<img style="width: 14px; height: 14px; position: absolute; right: 8px; top: 3px;" id="img-spinner" src="../images/ajax-loader.gif" alt="Loading"/>');

                                        health(torrent).then(function(health) {
                                            var ratio = health.peers > 0 ? (health.seeds / health.peers) : health.seeds;

                                            // Normalize the data. Convert each to a percentage
                                            var normalizedRatio = Math.min(ratio / 5 * 100, 100);
                                            // Seeds: Anything above 30 seeds is good
                                            var normalizedSeeds = Math.min(health.seeds / 30 * 100, 100);

                                            // Weight the above metrics differently
                                            // Ratio is weighted 60% whilst seeders is 40%
                                            var ratioWeight = normalizedRatio * 0.6;
                                            var seedsWeight = normalizedSeeds * 0.4;
                                            var totalWeight = (ratioWeight + seedsWeight) / 100;

                                            $(current).find('.circle').show();

                                            $(current).find('label').attr('title', 'Seeds '+health.seeds+' / Peers '+health.peers);
                                            $(current).find('.circle').circleProgress({
                                                value: totalWeight,
                                                animation: false,
                                                fill: {
                                                    color: "#66afe9"
                                                }
                                            });

                                            $(current).find('#img-spinner').remove();

                                        })
                                        .catch(function (err) {
                                            console.error(err);
                                            $(current.find('label').attr('title', 'Seeds unknown / Peers unknown'));
                                        });

                                        readTorrent(torrent, function(err, torrentInfo) {
                                            subtitles.search(torrentInfo.name, function (subs) {
                                                $('.subtitles').empty();
                                                $('.subtitles').append('<li><a class="subtitle" data-subname="No subtitle" data-subiso="" >No subtitle</a></li>');
                                                if( subs !== false ) {
                                                    console.log(subs);
                                                    for (var key in subs) {
                                                        var sub = subs[key];
                                                            $(".subtitles").append('<li><a class="subtitle" data-subname="'+sub.languageName+'" data-subiso="'+sub.languageName+'" >'+sub.languageName+'</a></li>');
                                                    }
                                                }
                                            });
                                        });
                                        currentTorrent = torrent;
                                    });

                                    $("body").on("click", ".subtitle", function () {
                                        var subIso = $(this).data("subiso");
                                        var subName = $(this).data("subname");
                                        $('#btnSubtitle').empty();
                                        $('#btnSubtitle').append('<i class="glyphicon glyphicon-play"></i>&nbsp;&nbsp;'+subName+'');

                                        currentSubtitle = subIso;
                                        console.log(currentSubtitle);
                                    });

                                    $(".container").height('100%');

                                    // Open first episode by default
                                    $("#accordion").find(".episode:first").trigger("click");

                                    $("#content-overlay").show();
                                    $("#serie").show();
                                    $("#side-bar-full").hide();
                                    $("#content").css("opacity", "0");
                                    $('#side-bar-small').attr("style", "display: none !important");
                                    $("#head-bar").hide();
                                }
                                else {
                                    console.log("Service not available");
                                }

                                $('.spinner-overlay').remove();
                            });

                        }

                        function changeFilterGenre(name) {
                            animeFilter.page = 0;
                            animeFilter.genre =  name;

                            var translatedGenre = translations.translate(name);
                            $("#filterByGenre").text(": " + translatedGenre);
                            $("#serieContainer").empty();
                            $('#serieContainer').isotope("destroy");
                            $('#serieContainer').isotope({
                                itemSelector: '.element',
                                animationEngine: 'jquery',
                                layoutMode: 'fitRows',
                                animationOptions: {
                                    duration: 600,
                                    easing: 'linear',
                                    queue: false
                                }
                            });

                            animeApplySearch();
                        }

                        function changeFilterCategory(name) {
                            //Change category name
                            animeFilter.sort = name;
                            animeFilter.page = 0;

                            if( animeFilter.sort == 'name' ) {
                                animeFilter.order = 'asc';
                            }
                            else {
                                animeFilter.order = 'desc';
                            }

                            var translatedCategory = translations.translate(name);
                            $("#filterByCategory").text(" : " + translatedCategory);
                            $("#serieContainer").empty();
                            $('#serieContainer').isotope("destroy");
                            $('#serieContainer').isotope({
                                itemSelector: '.element',
                                animationEngine: 'jquery',
                                layoutMode: 'fitRows',
                                animationOptions: {
                                    duration: 600,
                                    easing: 'linear',
                                    queue: false
                                }
                            });

                            //Apply the setting to search
                            animeApplySearch();
                        }

                        function changeFilterType(name) {
                            //Change category name
                            animeFilter.type = name;
                            animeFilter.page = 0;

                            //var translatedCategory = translations.translate(name);
                            $("#filterByType").text(" : " + name);
                            $("#serieContainer").empty();
                            $('#serieContainer').isotope("destroy");
                            $('#serieContainer').isotope({
                                itemSelector: '.element',
                                animationEngine: 'jquery',
                                layoutMode: 'fitRows',
                                animationOptions: {
                                    duration: 600,
                                    easing: 'linear',
                                    queue: false
                                }
                            });

                            //Apply the setting to search
                            animeApplySearch();
                        }

                        function changeStatusType(status) {
                            //Change category name
                            animeFilter.status = status;
                            animeFilter.page = 0;

                            console.log(status);

                            if( status == '' ) {
                                var translatedStatus = translations.translate('All');
                            }
                            else if( status == 0 ) {
                                var translatedStatus = translations.translate('Not Airing');
                            }
                            else if( status == 1 ) {
                                var translatedStatus = translations.translate('Currently Airing');
                            }
                            else if( status == 2 ) {
                                var translatedStatus = translations.translate('Ended');
                            }

                            $("#filterByStatus").text(" : " + translatedStatus);
                            $("#serieContainer").empty();
                            $('#serieContainer').isotope("destroy");
                            $('#serieContainer').isotope({
                                itemSelector: '.element',
                                animationEngine: 'jquery',
                                layoutMode: 'fitRows',
                                animationOptions: {
                                    duration: 600,
                                    easing: 'linear',
                                    queue: false
                                }
                            });

                            //Apply the setting to search
                            animeApplySearch();
                        }

                        function closeSerieDetail()
                        {
                            try{
                                var subManager = subtitles.getSubManager();
                                if( subManager ) {
                                    subManager.server.listen(0);
                                    subManager.server.close();
                                }
                            }
                            catch(e) {
                                console.log(e);
                            }

                            try{
                                $("#accordion").accordion("destroy");
                            }
                            catch(e) {
                                console.log(e);
                            }

                            $("#serie .devices").empty();
                            $("#content-overlay").hide();
                            $("#serie").hide();
                            $("#side-bar-full").show();
                            $("#side-bar-small").removeAttr( 'style' );
                            $("#content").css("opacity", "1");
                            $("#head-bar").show();
                            $("#btnBuy").unbind( "click" );
                            $("#accordion").empty();
                        }

                        function addToFavorites(animeJson) {
                            $('.favorites-template').empty();
                            var anime = $.parseJSON(animeJson.firstChild.innerHTML);
                            anime.type = 'anime';
                            favorites.addToFavorites(anime);
                            $(".favorites-template").append('<label onclick="removeFromFavorites(this);" title="Remove from favorites" class="current-favorites"><div style="display: none">'+JSON.stringify(anime)+'</div><i class="glyphicon glyphicon-heart"></i></label>');
                        }

                        function removeFromFavorites(animeJson) {
                            $('.favorites-template').empty();
                            var anime = $.parseJSON(animeJson.firstChild.innerHTML);
                            favorites.removeFromFavorites(anime.id);
                            $(".favorites-template").append('<label onclick="addToFavorites(this);" title="Add to favorites" class="current-favorites"><div style="display: none">'+JSON.stringify(anime)+'</div><i class="glyphicon glyphicon-heart-empty"></i></label>');
                        }

                    </script>

                    <div id="head-bar" class="p-10">
                        <div class="row" style="margin-right:0;">
                            <div class="col-lg-10">
                                <div class="input-group">
                                    <input id="txtAnimeSearch" type="text" class="form-control flixtor-input" placeholder="">
                                    <span class="input-group-btn">
                                        <button class="btn btn-flixtor" style="border-bottom-left-radius: 0px; border-top-left-radius: 0px; border-left: 0px;" type="button" id="btnSearchSerie" onclick="changeSearchText();">
                                            <span class="glyphicon glyphicon-search"></span>
                                        </button>
                                        <span class="ml-10">
                                            <button type="button" class="btn btn-flixtor dropdown-toggle" data-toggle="dropdown">Genre
                                                <span id="filterByGenre"></span>
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-flixtor" style="Max-height:400px;overflow-y:auto;" role="menu" id="ddmGenres">
                                                <li>
                                                    <a class="genreAll" onclick="changeFilterGenre('All');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreAction" onclick="changeFilterGenre('Action');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreAdventure" onclick="changeFilterGenre('Adventure');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreCars" onclick="changeFilterGenre('Cars');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreComedy" onclick="changeFilterGenre('Comedy');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreDementia" onclick="changeFilterGenre('Dementia');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreDemons" onclick="changeFilterGenre('Demons');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreDrama" onclick="changeFilterGenre('Drama');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreEcchi" onclick="changeFilterGenre('Ecchi');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreFantasy" onclick="changeFilterGenre('Fantasy');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreGame" onclick="changeFilterGenre('Game');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreHarem" onclick="changeFilterGenre('Harem');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreHistorical" onclick="changeFilterGenre('Historical');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreHorror" onclick="changeFilterGenre('Horror');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreJosei" onclick="changeFilterGenre('Josei');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreKids" onclick="changeFilterGenre('Kids');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreMagic" onclick="changeFilterGenre('Magic');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreMartialArts" onclick="changeFilterGenre('Martial Arts');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreMecha" onclick="changeFilterGenre('Mecha');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreMilitary" onclick="changeFilterGenre('Military');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreMusic" onclick="changeFilterGenre('Music');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreMystery" onclick="changeFilterGenre('Mystery');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreParody" onclick="changeFilterGenre('Parody');"></a>
                                                </li>
                                                <li>
                                                    <a class="genrePolice" onclick="changeFilterGenre('Police');"></a>
                                                </li>
                                                <li>
                                                    <a class="genrePsychological" onclick="changeFilterGenre('Psychological');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreRomance" onclick="changeFilterGenre('Romance');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSamurai" onclick="changeFilterGenre('Samurai');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSchool" onclick="changeFilterGenre('School');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSci-Fi" onclick="changeFilterGenre('Sci-Fi');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSeinen" onclick="changeFilterGenre('Seinen');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreShoujo" onclick="changeFilterGenre('Shoujo');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreShoujoAi" onclick="changeFilterGenre('Shoujo Ai');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreShounen" onclick="changeFilterGenre('Shounen');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreShounenAi" onclick="changeFilterGenre('Shounen Ai');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSliceOfLife" onclick="changeFilterGenre('Slice of Life');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSpace" onclick="changeFilterGenre('Space');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSports" onclick="changeFilterGenre('Sports');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSuperPower" onclick="changeFilterGenre('Super Power');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreSupernatural" onclick="changeFilterGenre('Supernatural');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreThriller" onclick="changeFilterGenre('Thriller');"></a>
                                                </li>
                                                <li>
                                                    <a class="genreVampire" onclick="changeFilterGenre('Vampire');"></a>
                                                </li>
                                            </ul>
                                        </span>
                                        <span class="ml-10">
                                            <button type="button" class="btn btn-flixtor dropdown-toggle" data-toggle="dropdown">Filter
                                                <span id="filterByCategory"></span>
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-flixtor pull-right" role="menu" id="ddmFilter">
                                                <li>
                                                    <a class="filterPopularity" onclick="changeFilterCategory('popularity')"></a>
                                                </li>
                                                <li>
                                                    <a class="filterRank" onclick="changeFilterCategory('rank')"></a>
                                                </li>
                                                <li>
                                                    <a class="filterName" onclick="changeFilterCategory('name')"></a>
                                                </li>
                                            </ul>
                                        </span>
                                    </span>
                                    <span class="input-group-btn">
                                        <span class="ml-10">
                                            <button type="button" class="btn btn-flixtor dropdown-toggle" data-toggle="dropdown">Type
                                                <span id="filterByType"></span>
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-flixtor" role="menu" id="ddmType">
                                                <li>
                                                    <a class="typeAll" onclick="changeFilterType('All')"></a>
                                                </li>
                                                <li>
                                                    <a class="typeMovie" onclick="changeFilterType('Movie')"></a>
                                                </li>
                                                <li>
                                                    <a class="typeShows" onclick="changeFilterType('TV')"></a>
                                                </li>
                                                <li>
                                                    <a class="typeOVA" onclick="changeFilterType('OVA')"></a>
                                                </li>
                                                <li>
                                                    <a class="typeONA" onclick="changeFilterType('ONA')"></a>
                                                </li>
                                            </ul>
                                        </span>
                                        <!--<span class="ml-10">
                                            <button type="button" class="btn btn-flixtor dropdown-toggle" data-toggle="dropdown">Status
                                                <span id="filterByStatus"></span>
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-flixtor pull-right" role="menu" id="ddmStatus">
                                                <li>
                                                    <a class="statusAll" onclick="changeStatusType('')"></a>
                                                </li>
                                                <li>
                                                    <a class="statusNotAiring" onclick="changeStatusType('0')"></a>
                                                </li>
                                                <li>
                                                    <a class="statusCurrentlyAiring" onclick="changeStatusType('1')"></a>
                                                </li>
                                                <li>
                                                    <a class="statusEnded" onclick="changeStatusType('2')"></a>
                                                </li>
                                            </ul>
                                        </span>-->
                                    </span>
                                </div>
                                <!-- /input-group -->
                            </div>
                            <!-- /.col-lg-6 -->
                            <div class="clearfix"></div>
                        </div>
                    </div>

                    <div id="serieContainer" class="isotope" style="overflow-y:auto !important;  margin-top: 10px; margin-right:10px;">
                        <!-- Dynamic content here -->
                    </div>
                    <div id="popup"></div>
                </div>

                <div id="content-overlay" style="display: none;">
                    <div id="serie" class="modal fade in p-30">
                        <div class="container center-block">
                            <div class="row">
                                <div id="season-info" class="col-sm-4">
                                    <div class="content-heading"><h3 id="title"></h3></div>
                                    <img style="float:left;width:200px; margin:0px 20px 20px 0px; box-shadow: 0px 0px 15px #374353;" id="poster" src="" />
                                    <div id="date" class="pt-10"><span class="glyphicon glyphicon-calendar"></span>&nbsp;&nbsp;</div>
                                    <div id="runtime" class="pt-10"><span class="glyphicon glyphicon-time"></span>&nbsp;&nbsp;</div>
                                    <div id="genres" class="pt-10"><span class="glyphicon glyphicon-tag"></span>&nbsp;&nbsp;</div>
                                    <div id="info" class="pt-10"><span class="glyphicon glyphicon-info-sign"></span>&nbsp;&nbsp;</div>
                                    <div id="network" class="pt-10"><span class="glyphicon glyphicon-home"></span>&nbsp;&nbsp;</div>
                                    <div class="pt-10">
                                        <span class="glyphicon glyphicon-star-empty"></span>&nbsp;&nbsp;
                                        <div class="stars-template" style="display:inline-block;">
                                            <div title="" id="rating" class="current-rating"></div>
                                        </div>
                                    </div>
                                    <div style="clear: both"></div>
                                    <div id="plot" class="pt-10"></div>
                                </div>
                                <div id="season-list" class="col-sm-4">
                                    <div id="accordion"></div>
                                </div>
                                <div id="season-episode" class="col-sm-4">
                                    <div class="content-heading"><h3 id="episode-title"></h3></div>
                                    <div id="episode-info"></div>
                                    <div id="episode-airdate"></div>
                                    <div class="ptb-30">
                                    <div class="btn-group" style="width: 100%;">
                                        <button type="button" id="btnSubtitle" class="btn btn-flixtor btn-sm" style="width: 90%;"><i class='glyphicon glyphicon-play'></i>&nbsp;&nbsp;No subtitle</button>
                                        <button type="button" class="btn btn-flixtor dropdown-toggle btn-sm" data-toggle="dropdown" style="width: 10%;">
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-flixtor subtitles" role="menu" style="width: 100%;">
                                        </ul>
                                    </div>
                                    </div>
                                    <div class="ptb-10">
                                        <div id="quality" class="btn-group">
                                        </div>
                                    </div>
                                    <div class="ptb-10">
                                        <div class="btn-group" style="width: 49%;">
                                            <button type="button" id="btnPlay" class="btn btn-flixtor btn-sm" style="width: 80%;"><i class='glyphicon glyphicon-play'></i>&nbsp;&nbsp;</button>
                                            <button type="button" class="btn btn-flixtor dropdown-toggle btn-sm disabled" data-toggle="dropdown" style="width: 20%;">
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu-flixtor dropdown-menu devices" role="menu" style="width: 100%;">
                                            </ul>
                                        </div>
                                        <button id="btnBuy" class="btn btn-flixtor btn-sm" style="width: 49%;"><i class='glyphicon glyphicon-shopping-cart'></i>&nbsp;&nbsp;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </body>
    </html>
